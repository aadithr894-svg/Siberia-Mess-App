{% extends 'base.html' %}

{% block content %}
<div class="container py-4">
    <div class="card shadow-sm border rounded-3">
        
        <!-- Header -->
        <div class="card-header text-center bg-light">
            <h4 class="mb-0">‚ûï Add Mess Cut</h4>
            <small class="text-muted">Assign mess cuts easily with search & date selection</small>
        </div>

        <!-- Body -->
        <div class="card-body bg-white">
            <form method="POST" id="messCutForm">

                <!-- Search Box -->
                <div class="mb-3">
                    <label class="form-label fw-bold">üîç Search User</label>
                    <input type="text" id="userSearch" 
                           class="form-control stylish-input" 
                           placeholder="Type a name or course...">
                </div>

                <!-- User List -->
                <div class="mb-3">
                    <label class="form-label fw-bold">üë§ Select User</label>
                    <div id="userList" class="stylish-list">
                        {% if users %}
                            {% for user in users %}
                            <div class="form-check user-item">
                                <input class="form-check-input" type="radio" 
                                       name="user_id" value="{{ user.id }}" id="user{{ user.id }}" required>
                                <label class="form-check-label" for="user{{ user.id }}">
                                    {{ user.name or "Unknown" }}{% if user.course %} ‚Äî {{ user.course }}{% endif %}
                                </label>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">‚ö†Ô∏è No users found in database</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Dates -->
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <label class="form-label fw-bold">üìÖ Start Date</label>
                        <input type="date" class="form-control stylish-date" 
                               name="start_date" id="startDate" required onkeydown="return false;">
                    </div>
                    <div class="col-12 col-md-6">
                        <label class="form-label fw-bold">üìÖ End Date</label>
                        <input type="date" class="form-control stylish-date" 
                               name="end_date" id="endDate" required onkeydown="return false;">
                    </div>
                </div>

                <!-- Submit -->
                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-success py-2 rounded-pill shadow-sm fs-5">
                        ‚úÖ Add Mess Cut
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Custom Styling -->
<style>
.stylish-input {
    border: 2px solid #007bff;
    border-radius: 12px;
    padding: 10px 14px;
    font-size: 16px;
}
.stylish-list {
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    max-height: 220px;
    overflow-y: auto;
    background: #fff;
}
.user-item {
    padding: 6px 10px;
    border-bottom: 1px solid #f1f1f1;
}
.user-item:last-child { border-bottom: none; }
.user-item:hover { background: #f8f9fa; border-radius: 6px; }
.stylish-date {
    border: 1px solid #ccc;
    border-radius: 8px;
    padding: 10px;
    font-size: 16px;
}
.stylish-date:focus {
    border-color: #28a745;
    outline: none;
}
@media (max-width: 576px) {
    .stylish-input, .stylish-date { font-size: 14px; padding: 8px; }
}
</style>

<!-- Scripts -->
<script>
// ‚úÖ Prevent selecting past dates
const today = new Date().toISOString().split("T")[0];
document.getElementById("startDate").setAttribute("min", today);
document.getElementById("endDate").setAttribute("min", today);

// ‚úÖ Auto enforce minimum 3 days gap
document.getElementById("startDate").addEventListener("change", function() {
    const start = new Date(this.value);
    if (isNaN(start)) return;
    const minEnd = new Date(start);
    minEnd.setDate(start.getDate() );
    const minEndStr = minEnd.toISOString().split("T")[0];
    document.getElementById("endDate").setAttribute("min", minEndStr);

    if (document.getElementById("endDate").value && 
        new Date(document.getElementById("endDate").value) < minEnd) {
        document.getElementById("endDate").value = "";
    }
});

// ‚úÖ Helper: format YYYY-MM-DD ‚Üí DD-MM-YYYY
function formatDate(dateStr) {
    const parts = dateStr.split("-");
    return `${parts[2]}-${parts[1]}-${parts[0]}`;
}

// ‚úÖ Validate + Confirm before submit
document.getElementById("messCutForm").addEventListener("submit", function(e) {
    const startInput = document.getElementById("startDate").value;
    const endInput = document.getElementById("endDate").value;

    const start = new Date(startInput);
    const end = new Date(endInput);
    const diff = (end - start) / (1000 * 60 * 60 * 24);

    if (diff < 3) {
        e.preventDefault();
        alert("‚ùå End date must be at least 3 days after start date!");
        return;
    }

    const selectedUser = document.querySelector("input[name='user_id']:checked");
    if (!selectedUser) {
        e.preventDefault();
        alert("‚ùå Please select a user.");
        return;
    }
    const userLabel = document.querySelector("label[for='" + selectedUser.id + "']").innerText;

    const confirmMsg = `‚úÖ Please confirm:\n\nüë§ User: ${userLabel}\nüìÖ Start: ${formatDate(startInput)}\nüìÖ End: ${formatDate(endInput)}\n\nDo you want to submit?`;
    
    if (!confirm(confirmMsg)) {
        e.preventDefault();
    }
});

// üîç Live search for users
document.getElementById("userSearch").addEventListener("keyup", function() {
    const searchValue = this.value.toLowerCase();
    const items = document.querySelectorAll("#userList .user-item");
    items.forEach(item => {
        const text = item.innerText.toLowerCase();
        item.style.display = text.includes(searchValue) ? "" : "none";
    });
});
</script>
{% endblock %}
